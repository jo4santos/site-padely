<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border-radius: 8px;
            border: 2px solid #0066CC;
            background: #0066CC;
            color: white;
            font-weight: bold;
        }
        button:hover {
            background: #0052A3;
        }
        .info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üîî Notification Test Page</h1>
    
    <div class="info">
        <h3>Current Status:</h3>
        <p><strong>Browser:</strong> <span id="browser">Checking...</span></p>
        <p><strong>Notification Support:</strong> <span id="support">Checking...</span></p>
        <p><strong>Permission:</strong> <span id="permission">Checking...</span></p>
        <p><strong>macOS DND:</strong> Check System Settings ‚Üí Focus ‚Üí Do Not Disturb is OFF</p>
    </div>

    <div>
        <button onclick="requestPermission()">1. Request Permission</button>
        <button onclick="sendTestNotification()">2. Send Test Notification</button>
        <button onclick="sendMultiple()">3. Send 3 Notifications</button>
        <button onclick="sendDelayedNotification()">4. Send Delayed Notification (5s)</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="log" id="log"></div>

    <div class="info">
        <h3>macOS Troubleshooting:</h3>
        <ol>
            <li>Open <strong>System Settings</strong></li>
            <li>Go to <strong>Notifications</strong></li>
            <li>Find your browser (Chrome/Safari/Firefox)</li>
            <li>Make sure notifications are <strong>ENABLED</strong></li>
            <li>Check <strong>Focus</strong> settings - turn OFF "Do Not Disturb"</li>
            <li>Try closing and reopening the browser</li>
        </ol>
    </div>

    <script>
        function log(message, isError = false) {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.style.color = isError ? '#ff5555' : '#00ff00';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            console.log(message);
        }

        function updateStatus() {
            // Browser
            document.getElementById('browser').textContent = navigator.userAgent.match(/(Chrome|Safari|Firefox|Edge)/i)?.[0] || 'Unknown';
            
            // Support
            const supported = 'Notification' in window;
            document.getElementById('support').textContent = supported ? '‚úÖ Supported' : '‚ùå Not Supported';
            document.getElementById('support').style.color = supported ? 'green' : 'red';
            
            // Permission
            if (supported) {
                const perm = Notification.permission;
                const permText = {
                    'granted': '‚úÖ Granted',
                    'denied': '‚ùå Denied',
                    'default': '‚ö†Ô∏è Not Asked Yet'
                };
                document.getElementById('permission').textContent = permText[perm] || perm;
                document.getElementById('permission').style.color = perm === 'granted' ? 'green' : perm === 'denied' ? 'red' : 'orange';
            }
        }

        async function requestPermission() {
            log('üîî Requesting notification permission...');
            
            if (!('Notification' in window)) {
                log('‚ùå Browser does not support notifications', true);
                alert('Your browser does not support notifications!');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                log(`üìã Permission result: ${permission}`);
                
                if (permission === 'granted') {
                    log('‚úÖ Permission granted! You can now receive notifications.');
                } else if (permission === 'denied') {
                    log('‚ùå Permission denied. Check browser settings.', true);
                } else {
                    log('‚ö†Ô∏è Permission dismissed. Try again.', true);
                }
                
                updateStatus();
            } catch (error) {
                log(`‚ùå Error requesting permission: ${error.message}`, true);
            }
        }

        function sendTestNotification() {
            log('üì¢ Attempting to send notification...');
            
            if (!('Notification' in window)) {
                log('‚ùå Notifications not supported', true);
                return;
            }

            if (Notification.permission !== 'granted') {
                log('‚ö†Ô∏è Permission not granted. Click "Request Permission" first.', true);
                alert('Please click "Request Permission" first!');
                return;
            }

            try {
                log('üî® Creating notification object...');
                const iconPath = `${window.location.origin}/favicon-32x32.png`;
                log(`üñºÔ∏è Using icon: ${iconPath}`);
                
                const notification = new Notification('Test Match: Player A vs Player B', {
                    body: 'This is a test notification from Padely. If you see this, notifications are working! üéæ',
                    icon: iconPath,
                    badge: iconPath,
                    tag: 'test-notification',
                    requireInteraction: false,
                    silent: false,
                    timestamp: Date.now(),
                });

                log('‚úÖ Notification created successfully!');
                log('üëÄ Check your desktop notification area');
                log('üí° Note: Some browsers may not show notifications when the page is active/focused');

                notification.onclick = () => {
                    log('üëÜ Notification clicked!');
                    window.focus();
                    notification.close();
                };

                notification.onerror = (error) => {
                    log(`‚ùå Notification error: ${error}`, true);
                };

                notification.onshow = () => {
                    log('üì∫ Notification is showing!');
                };

                notification.onclose = () => {
                    log('üö™ Notification closed');
                };

                setTimeout(() => {
                    notification.close();
                    log('‚è∞ Auto-closed after 8 seconds');
                }, 8000);

            } catch (error) {
                log(`‚ùå Failed to create notification: ${error.message}`, true);
                console.error(error);
            }
        }

        function sendMultiple() {
            if (Notification.permission !== 'granted') {
                alert('Please request permission first!');
                return;
            }

            log('üì¢ Sending 3 notifications...');
            
            for (let i = 1; i <= 3; i++) {
                setTimeout(() => {
                    const notif = new Notification(`Test Notification ${i}`, {
                        body: `This is notification number ${i}`,
                        tag: `test-${i}`
                    });
                    log(`‚úÖ Sent notification ${i}`);
                    
                    setTimeout(() => notif.close(), 5000);
                }, i * 1000);
            }
        }

        function sendDelayedNotification() {
            if (Notification.permission !== 'granted') {
                alert('Please request permission first!');
                return;
            }

            log('‚è±Ô∏è Sending notification in 5 seconds...');
            log('üí° Switch to another tab/app to test background notifications');
            
            setTimeout(() => {
                const iconPath = `${window.location.origin}/favicon-32x32.png`;
                const notif = new Notification('Delayed Test Notification', {
                    body: 'This notification was sent after 5 seconds delay',
                    icon: iconPath,
                    badge: iconPath,
                    tag: 'delayed-test'
                });
                log('‚úÖ Delayed notification sent');
                
                notif.onclick = () => {
                    log('üëÜ Delayed notification clicked!');
                    window.focus();
                    notif.close();
                };
                
                setTimeout(() => notif.close(), 8000);
            }, 5000);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('üßπ Log cleared');
        }

        // Initialize on load
        updateStatus();
        log('üöÄ Notification test page loaded');
        log('üì± Platform: ' + navigator.platform);
        log('üåê User Agent: ' + navigator.userAgent);
        log('üëÅÔ∏è Page visible: ' + !document.hidden);
        log('üîç Visibility state: ' + document.visibilityState);
        
        // Listen for visibility changes
        document.addEventListener('visibilitychange', () => {
            const isHidden = document.hidden;
            const state = document.visibilityState;
            log(`üëÅÔ∏è Page visibility changed: ${isHidden ? 'hidden' : 'visible'} (${state})`);
        });
    </script>
</body>
</html>
